<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using 'outForest' • outForest</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using 'outForest'">
<meta property="og:description" content="outForest">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">outForest</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/outForest.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mayer79/outForest/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using ‘outForest’</h1>
            
            <h4 data-toc-skip class="date">2023-04-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mayer79/outForest/blob/HEAD/vignettes/outForest.Rmd" class="external-link"><code>vignettes/outForest.Rmd</code></a></small>
      <div class="hidden name"><code>outForest.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>{outForest} is a random forest-based implementation of the method
described in Chapter 7.1.2 (“Regression model based anomaly detection”)
of <span class="citation">(<a href="#ref-Chandola2009" role="doc-biblioref">Chandola, Banerjee, and Kumar 2009</a>)</span>.
Each numeric variable is regressed onto all other variables using a
random forest. If the scaled absolute difference between observed value
and out-of-bag prediction is suspiciouly large (e.g. more than three
times the RMSE of the out-of-bag predictions), then a value is
considered an outlier. After identification of outliers, they can be
replaced e.g. by predictive mean matching from the non-outliers.</p>
<p>The method can be viewed as a multivariate extension of a basic
univariate outlier detection method, in which a value is considered an
outlier if it deviates from the mean by more than, say, three times the
standard deviation. In the multivariate case, instead of comparing a
value with the <em>overall mean</em>, rather the difference to the
<em>conditional mean</em> is considered. {outForest} estimates this
conditional mean by a random forest.</p>
<p>Specificly, the outlier score of the <span class="math inline">\(i\)</span>-th observed value <span class="math inline">\(x_{ij}\)</span> of variable <span class="math inline">\(j\)</span> is defined as <span class="math display">\[
  s_{ij} = \frac{x_{ij} - \text{pred}_{ij}}{\text{rmse}_j},
\]</span> where <span class="math inline">\(\text{pred}_{ij}\)</span> is
is the corresponding out-of-bag prediction of the <span class="math inline">\(j\)</span>th random forest with RMSE <span class="math inline">\(\text{rmse}_j\)</span>. If <span class="math inline">\(|s_{ij}| &gt; L\)</span> with threshold <span class="math inline">\(L\)</span>, then <span class="math inline">\(x_{ij}\)</span> is considered an outlier.</p>
<p>Why using random forests for calculating the conditional means? They
often work well without parameter tuning, outliers in the input
variables are no issue and the out-of-bag mechanism helps to provide
fair outlier scores.</p>
<p>{outForest} utilizes the high-performance random forest
implementation {ranger} <span class="citation">(<a href="#ref-wright2017" role="doc-biblioref">Wright and Ziegler
2017</a>)</span>. Since it does not allow for missing values, any
missing value is first being imputed by chained random forests
implemented in {missRanger}.</p>
<p>In the examples below, we will meet different functions from the
{outForest} package:</p>
<ul>
<li><p><code><a href="../reference/outForest.html">outForest()</a></code>: This is the main function. It
identifies and replaces outliers in numeric variables of a data
frame.</p></li>
<li><p><code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code>, <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> and
<code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>: To inspect outlier information.</p></li>
<li><p><code><a href="../reference/outliers.html">outliers()</a></code> and <code><a href="../reference/Data.html">Data()</a></code>: To extract
information on outliers and the data with replaced outliers.</p></li>
<li><p><code><a href="../reference/generateOutliers.html">generateOutliers()</a></code>: To add nasty outliers to a data
set.</p></li>
<li><p><code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>: To apply a fitted “outForest” object to
fresh data.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># From CRAN</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"outForest"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Development version</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"mayer79/outForest"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>We first generate a data set with two multivariate outliers. Then, we
use <code><a href="../reference/outForest.html">outForest()</a></code> to find them.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mayer79/outForest" class="external-link">outForest</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create data with multivariate outlier</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">pi</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">200</span><span class="op">)</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Let's run outForest on that data</span></span>
<span><span class="va">ch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/outForest.html">outForest</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span></code></pre></div>
<p><img src="outForest_files/figure-html/unnamed-chunk-2-1.png" width="576" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Outlier identification by random forests</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Variables to check:        x, y</span></span>
<span><span class="co">#&gt;   Variables used to check:   x, y</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Checking: x  y</span></span>
<span></span>
<span><span class="co"># What outliers did we find?</span></span>
<span><span class="fu"><a href="../reference/outliers.html">outliers</a></span><span class="op">(</span><span class="va">ch</span><span class="op">)</span></span>
<span><span class="co">#&gt;   row col observed predicted       rmse     score threshold replacement</span></span>
<span><span class="co">#&gt; 1 100   y      0.4 0.8567112 0.07485516 -6.101265         3   0.9913182</span></span>
<span><span class="co">#&gt; 2 200   y      0.4 0.8244413 0.07485516 -5.670168         3   0.8113720</span></span>
<span></span>
<span><span class="co"># Bingo! How does the fixed data set looks like?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="fu"><a href="../reference/Data.html">Data</a></span><span class="op">(</span><span class="va">ch</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p><img src="outForest_files/figure-html/unnamed-chunk-2-2.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># The number of outliers per variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ch</span><span class="op">)</span></span></code></pre></div>
<p><img src="outForest_files/figure-html/unnamed-chunk-2-3.png" width="576" style="display: block; margin: auto;"></p>
<p>Note that <code><a href="../reference/outForest.html">outForest()</a></code> offers a <code>...</code> argument
to pass options to its workhorse random forest implementation
<code>ranger()</code>, e.g. <code>num.trees</code> or <code>mtry</code>.
How would we use its “extra trees” variant with 50 trees? As data set,
we add a couple of outliers to the famous iris flower data set.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">irisWithOutliers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateOutliers.html">generateOutliers</a></span><span class="op">(</span><span class="va">iris</span>, p <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co">#&gt; 1          5.1         3.5      1.40000         0.2  setosa</span></span>
<span><span class="co">#&gt; 2          4.9         3.0    -13.32449         0.2  setosa</span></span>
<span><span class="co">#&gt; 3          4.7         3.2      1.30000         0.2  setosa</span></span>
<span><span class="co">#&gt; 4          4.6         3.1      1.50000         0.2  setosa</span></span>
<span><span class="co">#&gt; 5          5.0         3.6      1.40000         0.2  setosa</span></span>
<span><span class="co">#&gt; 6          5.4         3.9      1.70000         0.4  setosa</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/outForest.html">outForest</a></span><span class="op">(</span></span>
<span>  <span class="va">irisWithOutliers</span>, splitrule <span class="op">=</span> <span class="st">"extratrees"</span>, num.trees <span class="op">=</span> <span class="fl">50</span>, verbose <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The worst outliers</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/outliers.html">outliers</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   row          col   observed predicted      rmse     score threshold</span></span>
<span><span class="co">#&gt; 9  77  Petal.Width   8.617485  1.462865 0.6365155 11.240290         3</span></span>
<span><span class="co">#&gt; 7   2 Petal.Length -13.324488  1.572715 1.5200990 -9.800153         3</span></span>
<span><span class="co">#&gt; 6 135  Sepal.Width  -5.061389  3.120949 0.9375457 -8.727402         3</span></span>
<span><span class="co">#&gt; 1  66 Sepal.Length  16.880345  6.070454 1.4580339  7.414019         3</span></span>
<span><span class="co">#&gt; 2 127 Sepal.Length  -4.004644  6.355322 1.4580339 -7.105436         3</span></span>
<span><span class="co">#&gt; 8 136 Petal.Length  -4.054545  5.790103 1.5200990 -6.476321         3</span></span>
<span><span class="co">#&gt;   replacement</span></span>
<span><span class="co">#&gt; 9         1.5</span></span>
<span><span class="co">#&gt; 7         1.3</span></span>
<span><span class="co">#&gt; 6         3.0</span></span>
<span><span class="co">#&gt; 1         6.1</span></span>
<span><span class="co">#&gt; 2         7.3</span></span>
<span><span class="co">#&gt; 8         6.7</span></span>
<span></span>
<span><span class="co"># Summary of outliers</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt; The following outlier counts have been detected:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;              Number of outliers</span></span>
<span><span class="co">#&gt; Sepal.Length                  3</span></span>
<span><span class="co">#&gt; Sepal.Width                   3</span></span>
<span><span class="co">#&gt; Petal.Length                  2</span></span>
<span><span class="co">#&gt; Petal.Width                   1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; These are the worst outliers:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   row          col   observed predicted      rmse     score threshold</span></span>
<span><span class="co">#&gt; 9  77  Petal.Width   8.617485  1.462865 0.6365155 11.240290         3</span></span>
<span><span class="co">#&gt; 7   2 Petal.Length -13.324488  1.572715 1.5200990 -9.800153         3</span></span>
<span><span class="co">#&gt; 6 135  Sepal.Width  -5.061389  3.120949 0.9375457 -8.727402         3</span></span>
<span><span class="co">#&gt; 1  66 Sepal.Length  16.880345  6.070454 1.4580339  7.414019         3</span></span>
<span><span class="co">#&gt; 2 127 Sepal.Length  -4.004644  6.355322 1.4580339 -7.105436         3</span></span>
<span><span class="co">#&gt; 8 136 Petal.Length  -4.054545  5.790103 1.5200990 -6.476321         3</span></span>
<span><span class="co">#&gt;   replacement</span></span>
<span><span class="co">#&gt; 9         1.5</span></span>
<span><span class="co">#&gt; 7         1.3</span></span>
<span><span class="co">#&gt; 6         3.0</span></span>
<span><span class="co">#&gt; 1         6.1</span></span>
<span><span class="co">#&gt; 2         7.3</span></span>
<span><span class="co">#&gt; 8         6.7</span></span>
<span></span>
<span><span class="co"># Basic plot of the number of outliers per variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span></code></pre></div>
<p><img src="outForest_files/figure-html/unnamed-chunk-3-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Basic plot of the scores of the outliers per variable</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">out</span>, what <span class="op">=</span> <span class="st">"scores"</span><span class="op">)</span></span></code></pre></div>
<p><img src="outForest_files/figure-html/unnamed-chunk-3-2.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># The fixed data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/Data.html">Data</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co">#&gt; 1          5.1         3.5          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 2          4.9         3.0          1.3         0.2  setosa</span></span>
<span><span class="co">#&gt; 3          4.7         3.2          1.3         0.2  setosa</span></span>
<span><span class="co">#&gt; 4          4.6         3.1          1.5         0.2  setosa</span></span>
<span><span class="co">#&gt; 5          5.0         3.6          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 6          5.4         3.9          1.7         0.4  setosa</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="pipe">Pipe<a class="anchor" aria-label="anchor" href="#pipe"></a>
</h2>
<p><code><a href="../reference/outForest.html">outForest()</a></code> can be combined with the pipe:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">irisWithOutliers</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/outForest.html">outForest</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/Data.html">Data</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="out-of-sample-application">Out-of-sample application<a class="anchor" aria-label="anchor" href="#out-of-sample-application"></a>
</h2>
<p>Once an “outForest” object is fitted with option
<code>allow_predictions = TRUE</code>, it can be used to find and
replace outliers in new data without refitting. Note that random forests
can be huge, so use this option with care. Further note that currently,
missing values in the new data are only allowed in one single variable
to be checked.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/outForest.html">outForest</a></span><span class="op">(</span><span class="va">iris</span>, allow_predictions <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">iris1</span> <span class="op">&lt;-</span> <span class="va">iris</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="op">]</span></span>
<span><span class="va">iris1</span><span class="op">$</span><span class="va">Sepal.Length</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">out</span>, newdata <span class="op">=</span> <span class="va">iris1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/outliers.html">outliers</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span>
<span><span class="co">#&gt;   row          col observed predicted     rmse     score threshold replacement</span></span>
<span><span class="co">#&gt; 1   1 Sepal.Length       -1  5.011421 0.369207 -16.28198         3         5.2</span></span>
<span><span class="fu"><a href="../reference/Data.html">Data</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co">#&gt; 1          5.2         3.5          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 2          4.9         3.0          1.4         0.2  setosa</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-formula-interface">The formula interface<a class="anchor" aria-label="anchor" href="#the-formula-interface"></a>
</h2>
<p>By default, <code><a href="../reference/outForest.html">outForest()</a></code> uses all columns in the data set
to check all numeric columns with missings. To override this behaviour,
you can use its formula interface: The left hand side specifies the
variables to be checked (variable names separated by a <code>+</code>),
while the right hand side lists the variables used for checking.</p>
<p>So if you e.g. want to check only variable <code>Sepal.Length</code>
based on <code>Species</code>, then use this syntax.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/outForest.html">outForest</a></span><span class="op">(</span><span class="va">irisWithOutliers</span>, <span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">Species</span>, verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt; The following outlier counts have been detected:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;              Number of outliers</span></span>
<span><span class="co">#&gt; Sepal.Length                  3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; These are the worst outliers:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   row          col  observed predicted     rmse     score threshold replacement</span></span>
<span><span class="co">#&gt; 1  66 Sepal.Length 16.880345  5.928826 1.490069  7.349674         3         5.9</span></span>
<span><span class="co">#&gt; 2 127 Sepal.Length -4.004644  6.752837 1.490069 -7.219453         3         6.4</span></span>
<span><span class="co">#&gt; 3 135 Sepal.Length 13.663652  6.381728 1.490069  4.886972         3         7.4</span></span></code></pre></div>
<p>If you want to prevent <code><a href="../reference/outForest.html">outForest()</a></code> to identify and
replace outliers in the response variable of a subsequent model,
<code>Sepal.Length</code> say, subtract that variable from the left hand
side.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/outForest.html">outForest</a></span><span class="op">(</span><span class="va">irisWithOutliers</span>, <span class="va">.</span> <span class="op">-</span> <span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">.</span>, verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt; The following outlier counts have been detected:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;              Number of outliers</span></span>
<span><span class="co">#&gt; Sepal.Width                   4</span></span>
<span><span class="co">#&gt; Petal.Length                  2</span></span>
<span><span class="co">#&gt; Petal.Width                   1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; These are the worst outliers:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   row          col   observed  predicted      rmse     score threshold</span></span>
<span><span class="co">#&gt; 7  77  Petal.Width   8.617485  1.5489019 0.6485071 10.899777         3</span></span>
<span><span class="co">#&gt; 5   2 Petal.Length -13.324488  1.4629804 1.5531209 -9.521131         3</span></span>
<span><span class="co">#&gt; 4 135  Sepal.Width  -5.061389  3.2467161 0.9712182 -8.554314         3</span></span>
<span><span class="co">#&gt; 6 136 Petal.Length  -4.054545  6.0022195 1.5531209 -6.475198         3</span></span>
<span><span class="co">#&gt; 3 117  Sepal.Width   8.720982  2.9949163 0.9712182  5.895756         3</span></span>
<span><span class="co">#&gt; 2  66  Sepal.Width   3.100000 -0.8153869 0.9712182  4.031418         3</span></span>
<span><span class="co">#&gt;   replacement</span></span>
<span><span class="co">#&gt; 7         1.5</span></span>
<span><span class="co">#&gt; 5         1.4</span></span>
<span><span class="co">#&gt; 4         2.8</span></span>
<span><span class="co">#&gt; 6         5.9</span></span>
<span><span class="co">#&gt; 3         2.9</span></span>
<span><span class="co">#&gt; 2         2.4</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="too-many-values-are-identified-as-outliers--crap">Too many values are identified as outliers. Crap!<a class="anchor" aria-label="anchor" href="#too-many-values-are-identified-as-outliers--crap"></a>
</h2>
<p>For large data sets, just by chance, many values can surpass the
default threshold of 3. To reduce the number of outliers, the threshold
can be increased. Alternatively, the number of outliers can be limited
by the two arguments <code>max_n_outliers</code> and
<code>max_prop_outliers</code>. E.g. if at most three outliers are to be
identified, set <code>max_n_outliers = 3</code>. If at most 1% of the
values are to be declared as outliers, set
<code>max_prop_outliers = 0.01</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/outliers.html">outliers</a></span><span class="op">(</span><span class="fu"><a href="../reference/outForest.html">outForest</a></span><span class="op">(</span><span class="va">irisWithOutliers</span>, max_n_outliers <span class="op">=</span> <span class="fl">3</span>, verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   row          col   observed predicted      rmse     score threshold</span></span>
<span><span class="co">#&gt; 3  77  Petal.Width   8.617485  1.575285 0.6447998 10.921528  7.501523</span></span>
<span><span class="co">#&gt; 2   2 Petal.Length -13.324488  1.451632 1.5567481 -9.491657  7.501523</span></span>
<span><span class="co">#&gt; 1 135  Sepal.Width  -5.061389  3.219084 0.9663933 -8.568430  7.501523</span></span>
<span><span class="co">#&gt;   replacement</span></span>
<span><span class="co">#&gt; 3         1.5</span></span>
<span><span class="co">#&gt; 2         1.4</span></span>
<span><span class="co">#&gt; 1         3.1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="i-dont-want-outliers-to-be-replaced">I don’t want outliers to be replaced!<a class="anchor" aria-label="anchor" href="#i-dont-want-outliers-to-be-replaced"></a>
</h2>
<p>By default <code><a href="../reference/outForest.html">outForest()</a></code> replaces outliers by predictive
mean matching on the out-of-bag predictions. Alternatively, you can set
the <code>replace</code> argument to a different value:</p>
<ul>
<li><p><code>"no"</code>: Outliers are not replaced.</p></li>
<li><p><code>"predicted"</code>: Outliers are replaced by the out-of-bag
predictions (without predictive mean matching).</p></li>
<li><p><code>"NA"</code>: Outliers are replaced by missing
values.</p></li>
</ul>
<p>So if you would like to replace outliers by NAs, write:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/outForest.html">outForest</a></span><span class="op">(</span><span class="va">irisWithOutliers</span>, replace <span class="op">=</span> <span class="st">"NA"</span>, verbose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/Data.html">Data</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co">#&gt; 1          5.1         3.5          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 2          4.9         3.0           NA         0.2  setosa</span></span>
<span><span class="co">#&gt; 3          4.7         3.2          1.3         0.2  setosa</span></span>
<span><span class="co">#&gt; 4          4.6         3.1          1.5         0.2  setosa</span></span>
<span><span class="co">#&gt; 5          5.0         3.6          1.4         0.2  setosa</span></span>
<span><span class="co">#&gt; 6          5.4         3.9          1.7         0.4  setosa</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-algorithm-takes-too-much-time--what-can-i-do">The algorithm takes too much time. What can I do?<a class="anchor" aria-label="anchor" href="#the-algorithm-takes-too-much-time--what-can-i-do"></a>
</h2>
<p><code><a href="../reference/outForest.html">outForest()</a></code> is based on fitting one random forest for
each numeric variable. Since the underlying random forest implementation
<code>ranger()</code> uses 500 trees per default, a huge number of trees
might be calculated. For larger data sets, the overall process can take
very long.</p>
<p>Here are tweaks to make things faster:</p>
<ul>
<li><p>Use less trees, e.g. by setting <code>num.trees = 50</code>.
Don’t use a too low value because this can lead to missing out-of-bag
predictions.</p></li>
<li><p>Use smaller number of variables to be considered in a split,
e.g. <code>mtry = 2</code>.</p></li>
<li><p>Use smaller bootstrap samples by setting
e.g. <code>sample.fraction = 0.1</code>.</p></li>
<li><p>Use a low tree depth <code>max.depth = 6</code>.</p></li>
<li><p>Use large leafs,
e.g. <code>min.node.size = 10000</code>.</p></li>
</ul>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Chandola2009" class="csl-entry">
Chandola, Varun, Arindam Banerjee, and Vipin Kumar. 2009. <span>“Anomaly
Detection: A Survey.”</span> <em>ACM Comput. Surv.</em> 41 (3): 15:1–58.
<a href="https://doi.org/10.1145/1541880.1541882" class="external-link">https://doi.org/10.1145/1541880.1541882</a>.
</div>
<div id="ref-wright2017" class="csl-entry">
Wright, Marvin, and Andreas Ziegler. 2017. <span>“Ranger: A Fast
Implementation of Random Forests for High Dimensional Data in c++ and
r.”</span> <em>Journal of Statistical Software, Articles</em> 77 (1):
1–17. <a href="https://doi.org/10.18637/jss.v077.i01" class="external-link">https://doi.org/10.18637/jss.v077.i01</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Mayer.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
