---
title: "Using outRanger"
author: "Michael Mayer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{outRanger}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

## Introduction

The aim of this vignette is to introduce the R package `outRanger` for multivariate outlier detection and replacement.

`outRanger` is a random forest based implementation of the method described in Chapter 7.1.2 ("Regression Model Based Anomaly detection") of [1]. Each numeric variable is regressed onto all other variables using a random forest. If the scaled absolute difference between observed value and out-of-bag prediction is suspiciouly large (e.g. more than three times the RMSE of the out-of-bag predictions), then a value is considered an outlier. After identification of outliers, they can be replaced e.g. by predictive mean matching from the non-outliers.

The method can be viewed as a multivariate extension of a basic univariate outlier detection method where a value is considered an outlier if it is more than e.g. three times the standard deviation away from its mean. In the multivariate case, instead of comparing a value with the overall mean, rather the difference to the conditional mean is considered. The `outRanger` package estimates this conditional mean by a random forest.

Since the random forest algorithm `ranger` [2] does not allow for missing values, any missing value is first being imputed by chained random forests, see [3]. 

In the examples below, we will meet different functions from the `outRanger` package:

- `generateOutliers`: To add nasty outliers to a data set.

- `outRanger`: To identify and replace outliers in numeric variables of a data frame.

- `print`, `summary` and `plot`: To inspect outlier information.

- `outliers` and `Data`: To extract information on outliers and the modified data.

## Installation

From CRAN:
```
install.packages("outRanger")
```

Latest version from github:
```
library(devtools)
install_github("mayer79/outRanger")
```

## Examples

We first generate a data set with about 5% outliers per column and try to identify with `outRanger`.

``` {r}
library(outRanger)

# Generate data with outliers in numeric columns
irisWithOutliers <- generateOutliers(iris, seed = 34)
head(irisWithOutliers)
 
# Find outliers by random forest regressions and replace them by predictive mean matching.
(out <- outRanger(irisWithOutliers))

# Plot the number of outliers per numeric variable
plot(out)

# Information on all outliers
outliers(out)

# Resulting data set with replaced outliers
head(Data(out))

```

Note that `outRanger` offers a `...` argument to pass options to its workhorse random forest implementation `ranger`, e.g. `num.trees` or `min.node.size`. How would we use its "extra trees" variant with 50 trees?

``` {r}
head(Data(outRanger(irisWithOutliers, splitrule = "extratrees", num.trees = 50)))
```

Further note that `outRanger` does not rely on `tidyverse` but you can embed it into a `dplyr` pipeline (without `group_by`). Make sure to set `verbose = 0` in order to prevent messages flooding your screen. However, tibbles are not possible as input.

``` {r}
library(dplyr)

iris %>% 
  generateOutliers() %>% 
  outRanger(verbose = 0) %>%
  Data() %>% 
  head()
  
```

By default `outRanger` uses all columns in the data set to check all numeric columns with missings. To override this behaviour, you can use its interface: The left hand side specifies the variables to be checked (variable names separated by a `+`), while the right hand side lists the variables used for checking.

So if you e.g. want to check only variable `Sepal.Length` based on `Species`, then use this syntax.
``` {r}
out <- outRanger(irisWithOutliers, Sepal.Length ~ Species)

```

## The algorithm takes too much time. What can I do?

`outRanger` is based on fitting one random forest for each numeric variable. Since the underlying random forest implementation `ranger` uses 500 trees per default, a huge number of trees might be calculated. For larger data sets, the overall process can take very long.

Here are tweaks to make things faster:

- Use less trees, e.g. by setting `num.trees = 50`. Typically, the number of iterations until convergence will increase with fewer trees though.

- Use smaller number of variables to be considered in a split, e.g. `mtry = 2`.

- Use smaller bootstrap samples by setting e.g. `sample.fraction = 0.1`.

- Use a low tree depth `max.depth = 6`.

- Use large leafs, e.g. `min.node.size = 10000`.

## References

[1] Chandola V., Banerjee A., and Kumar V. (2009). Anomaly detection: A survey. ACM Comput. Surv. 41, 3, Article 15 (http://dx.doi.org/10.1145/1541880.1541882).

[2]  Wright, M. N. & Ziegler, A. (2016). ranger: A Fast Implementation of Random Forests for High Dimensional Data in C++ and R. Journal of Statistical Software, in press (http://arxiv.org/abs/1508.04409). 

[3]  Van Buuren, S. and Groothuis-Oudshoorn, K. (2011). mice: Multivariate Imputation by Chained Equations in R. Journal of Statistical Software, 45(3), 1-67 (http://www.jstatsoft.org/v45/i03/).
